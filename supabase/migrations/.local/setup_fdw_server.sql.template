-- ============================================================================
-- FOREIGN DATA WRAPPER SETUP - S3 Vectors (Supabase Storage)
-- ============================================================================
--
-- Este arquivo √© um TEMPLATE para configura√ß√£o do Foreign Data Wrapper.
-- N√ÉO deve ser commitado com credenciais reais.
--
-- ‚ö†Ô∏è IMPORTANTE: 
-- - Copie este arquivo para: setup_fdw_server.sql
-- - Substitua os placeholders <...> pelas credenciais reais
-- - Adicione setup_fdw_server.sql ao .gitignore
--
-- üîí SEGURAN√áA:
-- - Use credenciais do Supabase Vault
-- - Credenciais diferentes para cada ambiente (dev/staging/prod)
-- - Rotacione credenciais periodicamente
--
-- üìã Consulte: docs/FDW_SETUP.md para instru√ß√µes completas
-- ============================================================================

-- Pr√©-requisito: Extension wrappers (j√° instalada via migration principal)
-- CREATE EXTENSION IF NOT EXISTS "wrappers" WITH SCHEMA "extensions";

-- 1. Criar Foreign Data Wrapper
CREATE FOREIGN DATA WRAPPER IF NOT EXISTS "dataro_it_fdw" 
  HANDLER "extensions"."s3_vectors_fdw_handler" 
  VALIDATOR "extensions"."s3_vectors_fdw_validator";

-- 2. Criar Server com credenciais espec√≠ficas do ambiente
CREATE SERVER IF NOT EXISTS "dataro_it_fdw_server" 
  FOREIGN DATA WRAPPER "dataro_it_fdw" 
  OPTIONS (
    "aws_region" 'us-west-2',
    "endpoint_url" 'https://wntiupkhjtgiaxiicxeq.storage.supabase.co/storage/v1/vector',
    "vault_access_key_id" '<SEU_VAULT_ACCESS_KEY_ID>',      -- ‚ö†Ô∏è SUBSTITUIR
    "vault_secret_access_key" '<SEU_VAULT_SECRET_ACCESS_KEY>' -- ‚ö†Ô∏è SUBSTITUIR
  );

-- 3. Definir owner como postgres
ALTER SERVER "dataro_it_fdw_server" OWNER TO "postgres";

-- ============================================================================
-- VALIDA√á√ÉO
-- ============================================================================

-- Verificar se FDW foi criado
SELECT 
  fdwname as "Foreign Data Wrapper",
  fdwhandler::regproc as "Handler",
  fdwvalidator::regproc as "Validator"
FROM pg_foreign_data_wrapper 
WHERE fdwname = 'dataro_it_fdw';

-- Verificar se Server foi criado
SELECT 
  srvname as "Server Name",
  srvoptions as "Options"
FROM pg_foreign_server 
WHERE srvname = 'dataro_it_fdw_server';

-- ============================================================================
-- INSTRU√á√ïES DE USO
-- ============================================================================
--
-- PASSO 1: Obter credenciais
-- -------------------------
-- Dashboard: Supabase Dashboard > Settings > Vault
-- CLI:       supabase secrets list
--
-- PASSO 2: Copiar e configurar
-- -------------------------
-- $ cp supabase/migrations/.local/setup_fdw_server.sql.template \
--      supabase/migrations/.local/setup_fdw_server.sql
--
-- PASSO 3: Editar e substituir placeholders
-- -------------------------
-- Substitua <SEU_VAULT_ACCESS_KEY_ID> e <SEU_VAULT_SECRET_ACCESS_KEY>
-- pelas credenciais obtidas no Passo 1
--
-- PASSO 4: Aplicar no banco de dados
-- -------------------------
-- Op√ß√£o A - Supabase Dashboard:
--   1. Acesse SQL Editor
--   2. Cole o conte√∫do do arquivo editado
--   3. Execute
--
-- Op√ß√£o B - Supabase CLI (local):
--   $ supabase db execute --file supabase/migrations/.local/setup_fdw_server.sql
--
-- PASSO 5: Validar
-- -------------------------
-- Execute as queries de valida√ß√£o acima para confirmar que o FDW
-- foi criado corretamente
--
-- ============================================================================
-- ROLLBACK (Se necess√°rio)
-- ============================================================================
--
-- DROP SERVER IF EXISTS dataro_it_fdw_server CASCADE;
-- DROP FOREIGN DATA WRAPPER IF EXISTS dataro_it_fdw CASCADE;
--
-- ============================================================================
-- SEGURAN√áA
-- ============================================================================
--
-- ‚úÖ FAZER:
-- - Usar credenciais do Vault espec√≠ficas do ambiente
-- - Rotacionar credenciais periodicamente
-- - Adicionar setup_fdw_server.sql ao .gitignore
-- - Documentar credenciais em gerenciador de senhas
--
-- ‚ùå N√ÉO FAZER:
-- - Commitar credenciais no Git
-- - Compartilhar credenciais em Slack/Email/Docs
-- - Usar mesmas credenciais em todos os ambientes
-- - Copiar credenciais em logs ou documenta√ß√£o p√∫blica
--
-- ============================================================================

-- √öltima atualiza√ß√£o: 2026-01-02T19:17:00Z
-- Respons√°vel: DevOps/Backend Team
